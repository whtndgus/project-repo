<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <form id="doctors-register-form" method="post">
      <div>
        <!-- 이미지 미리보기를 위한 영역 -->
        <div
          id="preview-container"
          style="
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
          "
        >
          <img
            id="preview-img"
            src="../assets/img/default_profile.png"
            style="width: 100%; height: 100%"
          />
        </div>

        <!-- 파일 선택 버튼 -->
        <input
          type="file"
          id="file-input"
          accept="image/*"
          name="files"
          onchange="previewImage(event);"
        />
      </div>

      <label for="id-input">ID:</label>
      <input type="text" id="id-input" name="id" required />
      <button type="button" id="check-duplicate-btn">중복확인</button>
      <div id="message"></div>
      <label for="password">비밀번호:</label>
      <input
        type="password"
        name="password"
        id="password"
        placeholder="최소 8자 이상 문자, 숫자, 특수 문자를 포함하여 작성하세요."
        pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[$@$!%*#?&])[A-Za-z\d$@$!%*#?&]{8,}$"
        required
      /><br />
      <label for="confirmPassword">비밀번호 확인:</label>
      <input
        type="password"
        name="confirmPassword"
        id="confirmPassword"
        required
      /><br />
      <label for="name">이름:</label>
      <input type="text" id="name" name="name" required /><br />

      <label>생년월일:</label>
      <input type="date" name="birth" required /><br />
      <label>성별:</label>
      <input
        class="form-check-input"
        type="radio"
        name="gender"
        id="gender-m"
        value="0"
        checked
      />
      <label class="form-check-label" for="gender-m"> 남 </label>
      <input
        class="form-check-input"
        type="radio"
        name="gender"
        id="gender-w"
        value="1"
      />
      <label class="form-check-label" for="gender-w"> 여 </label>
      <div>
        <label for="email-id">이메일 주소</label>
        <input type="text" id="email-id" name="email" required />
        @
        <select id="email-domain" required>
          <option value="">이메일 도메인을 선택하세요</option>
          <option value="naver.com">naver.com</option>
          <option value="gmail.com">gmail.com</option>
          <option value="daum.net">daum.net</option>
          <option value="직접입력">직접입력</option>
        </select>
        <input type="text" id="email-direct" style="display: none" />
      </div>
      <label>주소:</label>
      <input
        type="text"
        id="postcode"
        placeholder="우편번호"
        name="addr"
        readonly
        required
      />
      <input
        type="button"
        onclick="execDaumPostcode()"
        value="우편번호 찾기"
      /><br />
      <input
        type="text"
        id="roadAddress"
        placeholder="도로명주소"
        required
        readonly
      />
      <input
        type="text"
        id="jibunAddress"
        placeholder="지번주소"
        readonly
      /><br />
      <input type="text" id="detailAddress" placeholder="상세주소" required />
      <input
        type="text"
        id="extraAddress"
        placeholder="참고항목"
        readonly
      /><br />
      <label>전화번호:</label>
      <input
        type="tel"
        id="tel"
        name="tel"
        placeholder="휴대폰 번호"
        required
      /><br />
      <input type="button" value="가입하기" id="btn-insert" />
    </form>
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <script>
      const idInput = document.querySelector('#id-input');
      const messageDiv = document.querySelector('#message');
      const checkDuplicateBtn = document.querySelector('#check-duplicate-btn');
      let isDuplicate = true;
  
      const emailIdInput = document.querySelector('#email-id');
      const emailDomainSelect = document.querySelector('#email-domain');
      const emailDirectInput = document.querySelector('#email-direct');
      // 프로필 이미지
      function previewImage(event) {
        const input = event.target;
        if (input.files && input.files[0]) {
          const reader = new FileReader();
          reader.onload = function (e) {
            const previewImg = document.querySelector('#preview-img');
            previewImg.src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        } else {
          const previewImg = document.querySelector('#preview-img');
          previewImg.src = '../assets/img/default_profile.png'; // 기본 이미지 경로
        }
      }


      // ID 중복 확인 버튼 클릭 이벤트
      checkDuplicateBtn.onclick = () => {
        const id = idInput.value;
        fetch(`http://localhost:8080/doctors/check-duplicate/${id}`)
          .then((response) => response.json())
          .then((result) => {
            console.log(result);
            if (result.status === 'FAILURE') {
              messageDiv.textContent = result.message;
              isDuplicate = true;
            } else {
              messageDiv.textContent = result.message;
              isDuplicate = false;
            }
          })
          .catch((exception) => {
            console.error('ID 중복 확인 중 오류 발생:', exception);
            messageDiv.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
          });
      };

      // 이메일 유효성 검사
      emailIdInput.addEventListener('input', updateEmailValue);
      emailDomainSelect.addEventListener('change', updateEmailValue);

      function updateEmailValue() {
        const emailId = emailIdInput.value;
        const emailDomain = emailDomainSelect.value;
        let emailValue = '';

        if (emailId !== '' && emailDomain !== '직접입력') {
          emailDirectInput.style.display = 'none';
          emailDirectInput.required = false;
          emailDirectInput.removeAttribute('pattern');
          emailValue = `${emailId}@${emailDomain}`;
        } else if (emailId !== '' && emailDomain === '직접입력') {
          emailDirectInput.style.display = 'inline-block';
          emailDirectInput.required = true;
          emailDirectInput.pattern =
            "^([!#-'*+/-9=?A-Z^-~-]+(\.[!#-'*+/-9=?A-Z^-~-]+)*|\[[\t -Z^-~]*])";
          emailValue = `${emailId}@${emailDirectInput.value}`;
        }

        emailIdInput.setAttribute('value', emailValue);
        return emailValue;
      }

      // 주소찾기
      function execDaumPostcode() {
        new daum.Postcode({
          oncomplete: function (data) {
            // 팝업에서 검색결과 항목을 클릭했을때 실행할 코드를 작성하는 부분.

            // 도로명 주소의 노출 규칙에 따라 주소를 표시한다.
            // 내려오는 변수가 값이 없는 경우엔 공백('')값을 가지므로, 이를 참고하여 분기 한다.
            var roadAddr = data.roadAddress; // 도로명 주소 변수
            var extraRoadAddr = ''; // 참고 항목 변수

            // 법정동명이 있을 경우 추가한다. (법정리는 제외)
            // 법정동의 경우 마지막 문자가 "동/로/가"로 끝난다.
            if (data.bname !== '' && /[동|로|가]$/g.test(data.bname)) {
              extraRoadAddr += data.bname;
            }
            // 건물명이 있고, 공동주택일 경우 추가한다.
            if (data.buildingName !== '' && data.apartment === 'Y') {
              extraRoadAddr +=
                extraRoadAddr !== ''
                  ? ', ' + data.buildingName
                  : data.buildingName;
            }
            // 표시할 참고항목이 있을 경우, 괄호까지 추가한 최종 문자열을 만든다.
            if (extraRoadAddr !== '') {
              extraRoadAddr = ' (' + extraRoadAddr + ')';
            }

            // 우편번호와 주소 정보를 해당 필드에 넣는다.
            document.getElementById('postcode').value = data.zonecode;
            document.getElementById('roadAddress').value = roadAddr;
            document.getElementById('jibunAddress').value = data.jibunAddress;

            // 참고항목 문자열이 있을 경우 해당 필드에 넣는다.
            if (roadAddr !== '') {
              document.getElementById('extraAddress').value = extraRoadAddr;
            } else {
              document.getElementById('extraAddress').value = '';
            }
          },
        }).open();
      }

      document.querySelector('#btn-insert').onclick = () => {
        const form = document.querySelector('#doctors-register-form');
        const formData = new FormData(form);
        if (isDuplicate) {
          messageDiv.textContent = 'ID를 중복 확인하세요.';
          return;
        }

        if (password.value !== confirmPassword.value) {
          messageDiv.textContent = '비밀번호가 다릅니다';
          return;
        }

        const fileInput = document.querySelector('#file-input');

        if (fileInput.files && fileInput.files[0]) {
          formData.append('phoName', fileInput.files[0].name);
          formData.append('phoType', fileInput.files[0].type);
        }

        const emailValue = updateEmailValue();
        formData.set('email', emailValue);

        const zipcode = document.getElementById('postcode').value;
        const roadAddress = document.getElementById('roadAddress').value;
        const detailAddress = document.getElementById('detailAddress').value;
        formData.set('addr', `${zipcode}: ${roadAddress} ${detailAddress}`);

        const tel = document.getElementById('tel').value;
        formData.set('tel', `${tel}`);

        if (form.checkValidity()) {
          let url = '';
          let json;
          new Promise((resolve) => {
            url = submitFiles();
            console.log(url);
            resolve();
          }).then(() => {
            formData.append('phoUrl', url);
            json = JSON.stringify(Object.fromEntries(formData));
            console.log(json);
            fetch('http://localhost:8080/doctors', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: json,
            })
              .then((response) => response.json())
              .then((result) => {
                if (result.status == 'success') {
                  // location.reload();
                  console.log('성공:', result);
                } else {
                  alert('입력실패');
                  console.log(result.data);
                }
              })
              .catch((exception) => {
                alert('입력 중 오류 발생');
                console.log(exception);
              });
          });
        } else {
          form.reportValidity();
        }
      };

      function submitFiles() {
        let str = '';
        let formData = new FormData();
        let files = $('input[name=files]')[0].files;
        if (files.length == 0) {
          return;
        }
        formData.append('files', files[0]);
        $.ajax({
          url: 'http://localhost:8080/doctors/profileimg',
          data: formData,
          cache: false,
          async: false,
          contentType: false,
          processData: false,
          type: 'POST',
          success: function (data) {
            str = data;
            // console.log(str);
          },
          error: function (e) {
            console.log('데이터 업로드 실패');
          },
        });
        return str;
      }
    </script>
  </body>
</html>
