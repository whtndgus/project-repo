<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8"> 
  <meta content="width=device-width, initial-scale=1.0" name="viewport">

  <title>의사 - Main</title>
  <meta content="" name="description">
  <meta content="" name="keywords">
 
  <!--구글폰트-->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;700&display=swap" rel="stylesheet">
  <!-- Favicons -->
  <link href="../assets/img/newlogo.png" rel="icon">
  <link href="../assets/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link
    href="https://fonts.googleapis.com/css?family=Open+Sans:300,300i,400,400i,600,600i,700,700i|Nunito:300,300i,400,400i,600,600i,700,700i|Poppins:300,300i,400,400i,500,500i,600,600i,700,700i"
    rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="../assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="../assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
  <link href="../assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  <link href="../assets/vendor/quill/quill.snow.css" rel="stylesheet">
  <link href="../assets/vendor/quill/quill.bubble.css" rel="stylesheet">
  <link href="../assets/vendor/remixicon/remixicon.css" rel="stylesheet">
  <link href="../assets/vendor/simple-datatables/style.css" rel="stylesheet">

  <!-- Template Main CSS File -->
  <link href="../assets/css/style.css" rel="stylesheet">

  <!-- =======================================================
  * Template Name: NiceAdmin
  * Updated: Mar 09 2023 with Bootstrap v5.2.3
  * Template URL: https://bootstrapmade.com/nice-admin-bootstrap-admin-html-template/
  * Author: BootstrapMade.com
  * License: https://bootstrapmade.com/license/
  ======================================================== -->
  <style>
    .pagination {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }

    body::-webkit-scrollbar {
      background-color: transparent;
    }

    .hos-time::-webkit-scrollbar {
      width: 10px;
    }

    .hos-time::-webkit-scrollbar-track {
      background-color: transparent;
    }

    .hos-time::-webkit-scrollbar-thumb {
      background-color: transparent;
      border: none;
    }
    .hos-tr{
      cursor: pointer;
    }
  </style>
</head>

<body>

  <!-- ======= Header ======= -->
  <header id="header" class="header fixed-top d-flex align-items-center">

    <div class="d-flex align-items-center justify-content-between">
      <a class="logo d-flex align-items-center">
        <img src="../register/assets/img/headerlogo-d.png">
      </a>
      <i class="bi bi-list toggle-sidebar-btn"></i>
    </div>
    <!-- End Logo -->
    <div class="top-menu">
      <a href="hospitals-list.html" class="nav-link"><span>병원</span></a>
  
      <a href="doctors-community-main.html" class="nav-link collapsed"
        ><span>커뮤니티</span></a
      >
    </div>
    <nav class="header-nav ms-auto">
      <ul class="d-flex align-items-center">
        <li class="nav-item dropdown pe-3">
          <a
            class="nav-link nav-profile d-flex align-items-center pe-0"
            href="doctors-profile.html"
          >
            <div id="pre-userimg"></div>
            <span id="username" class="d-none d-md-block ps-2"></span>
          </a>
        </li>
      </ul>
    </nav>
  </header>
  <!-- ======= Sidebar ======= -->
  <aside id="sidebar" class="sidebar">
    <ul class="sidebar-nav" id="sidebar-nav">
      <li class="nav-heading">의사 전용 페이지</li>

      <li class="nav-item">
        <a class="nav-link collapsed" href="doctors-profile.html">
          <i class="bi bi-person"></i>
          <span>내 정보</span>
        </a>
      </li>
      <!-- End Profile Page Nav -->

      <li class="nav-item">
        <a class="nav-link collapsed" href="doctors-advices.html">
          <i class="bi bi-file-earmark"></i>
          <span>진료하기</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link collapsed" href="QnQ-doc.html">
          <i class="bi bi-question-circle"></i>
          <span>문의하기</span>
        </a>
      </li>

      <li class="nav-item">
        <a class="nav-link collapsed" href="hospitals-view.html">
          <i class="bi bi-card-list"></i>
          <span>내 병원 정보</span>
        </a>
      </li>
      <!-- End Register Page Nav -->

      <!-- 로그아웃 태그 -->
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
      <li class="nav-item logout">
        <a class="nav-link collapsed">
          <i class="bi bi-box-arrow-in-right"></i>
          <span>로그아웃</span>
        </a>
      </li>
      <!-- End Login Page Nav -->
      <script>
        $(".logout").click(() => {
          console.log(11);
          fetch(`http://175.106.99.31/auth/logout`, {
            method: "GET",
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status == "success") {
                location.href = "";
              } else {
                alert("로그아웃 실패");
                location.href = "";
              }
            });
        });
      </script>
    </ul>
    <img
    src="../register/assets/img/mainlogo.png"
    style="height: 150px; margin-top: 400px; margin-left: 40px"
  />
  </aside><!-- End Sidebar-->

  <main id="main" class="main">

    <div class="pagetitle">
      <h1>병원정보</h1>
   
    </div><!-- End Page Title -->

    <section class="section">
      <div class="row">
        <div class="container">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <button type="button" style="margin-top: 15px;" class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                  병원추가
                </button>               
                <h4 class="card-title" style="float: right;">
                <input type="text" id="search-input" class="form-control" placeholder="병원정보검색">
                </h4>
                <table id="foo-table" class="table table-hover">
                  <thead>
                    <tr>
                      <!-- table 작업시에 <th><td> 갯수가 서로 일치하지 않으면 정렬 버튼 사라집니다 -->
                      <th scope="col">번호</th>
                      <th scope="col">병원명</th>
                      <th scope="col">주소</th>
                      <th scope="col">전화</th>
                      <th scope="col">진료과목</th>
                    </tr>
                  </thead>
                  <tbody id="hospital-list" class="table-group-divider">
                    <tr id="hospital-list-detail">
                      <td id="hospitalNo"></td>
                      <td id="hospitalName"></td>
                      <td id="hospitalAddr"></td>
                      <td id="hospitalTel"></td>
                      <td id="hospitalSub"></td>
                    </tr>
                  </tbody>
                </table>

    
                <div class="modal fade" id="staticBackdrop" data-bs-backdrop="static" tabindex="-1"
                  aria-labelledby="staticBackdropLabel" aria-hidden="true">
                  <div class="modal-dialog modal-xl" style="max-width: 1600px;">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h1 class="modal-title fs-5" id="staticBackdropLabel">병원추가</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                      </div>
                      <div class="modal-body" style="max-height: 300px; overflow-y: auto;">
                        <table id="foo-table2" class="table-hover cursor">
                          <thead>
                            <tr>
                              <th scope="col">병원명</th>
                              <th scope="col">주소</th>
                              <th scope="col">전화<span id="id-validation-msg" class="validation-msg"></span></th>
                              <th scope="col">진료시간</th>
                              <th scope="col">진료과목</th>
                              <th scope="col">병원 비밀번호</th>
                              <th scope="col">병원사진</th>
                            </tr>
                          </thead>
                          <style>
                            input[type="number"]::-webkit-inner-spin-button {
                                -webkit-appearance: none;
                                margin: 0;
                            }
                          </style>
                          <form id="hospital-list">
                            <tbody class="table-group-divider">
                              <div class="hospital-list-css">
                                <tr>
                                  <td class="mb-3"><input id="hosName" class="hos-name form-control" type="text" placeholder='병원이름' /></td>
                                  <td class="mb-3"><input id="hosAddr" class="hos-addr form-control" type="text" placeholder='주소'/></td>
                                  <td class="mb-3"><input id="hosTel" class="hos-tel form-control" type="number" placeholder="'-' 없이 입력"
                                    maxlength="11"
                                      oninput="changeNo()" required /></td>
                                    <script>
                                      function changeNo(){
                                        if( document.querySelector(".hos-tel").value.length > document.querySelector(".hos-tel").maxLength) {
                                          document.querySelector(".hos-tel").value = document.querySelector(".hos-tel").value.substring(0,11);
                                        }
                                      }
                                    </script>
                                  <td class="mb-3"><input id="hosTime" class="hos-time form-control" type="text"
                                      placeholder="예:월~금 08시~18시30분,토 휴진" /></td>
                                  <td class="mb-3"><input id="hosSub" class="hos-sub form-control" type="text" placeholder="예: 가정의학과,소아과" /></td>
                                  <td class="mb-3"><input id="hosPwd" class="hos-pwd form-control" type="password" placeholder="비밀번호를 4자이상 입력"/></td>                      
                                  <form>
                                    <td class="mb-3"><input type="file" id="hosPhoto" class="hos-photo hospital-files form-control"
                                        style="width: 220px;" accept="image/*" multiple></td>
                                  </form>
                                </tr>
                              </div>
                            </tbody>
                          </form>
                        </table>
                      </div>
                      <div id="hospital-success-message" style="display: none; text-align: center; color: #77DD77;">
                        <h4>✅추가되었습니다.</h4>
                      </div>
                      <div class="modal-footer justify-content-between">

                        <button type="button" class="btn btn btn-outline-dark mr-auto" onclick="location.reload()"
                          data-bs-dismiss="modal">Close</button>
                        <button type="button" id="btn-submit" class=" btn btn-outline-success" >병원추가</button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

          </div>
        </div>
    </section>
  </main><!-- End #main -->




  <!-- ======= Footer ======= -->
  <footer id="footer" class="footer">
    <div >
     <div class="tooltip-container">
        <a href="https://github.com/whtmdgus" data-bs-toggle="tooltip" data-bs-placement="top" title="조승현">
          <img src="../register/assets/img/gitlogo.png" style="width:40px">
        </a>
        <a href="https://github.com/chaminju927" data-bs-toggle="tooltip" data-bs-placement="top" title="차민주">
          <img src="../register/assets/img/gitlogo.png" style="width:40px">
        </a>
        <a href="https://github.com/molang2" data-bs-toggle="tooltip" data-bs-placement="top" title="이준영">
          <img src="../register/assets/img/gitlogo.png" style="width:40px">
        </a>
        <a href="https://github.com/hyunwookimkim" data-bs-toggle="tooltip" data-bs-placement="top" title="김현우">
          <img src="../register/assets/img/gitlogo.png" style="width:40px">
        </a>
        <a href="https://github.com/omelase" data-bs-toggle="tooltip" data-bs-placement="top" title="이예찬">
          <img src="../register/assets/img/gitlogo.png" style="width:40px">
        </a>
     </div>
     <div class="footer-img-container">
       <img src ="../register/assets/img/bitcamplogo.png" > 
       <img src ="../register/assets/img/navercloudlogo.png" style="width:200px; margin-left: 50px;"> 
       <img src ="../register/assets/img/magicecole.png" style="width:150px; margin-left: 50px;">
      </div>
    </div>
      </footer><!-- End Footer -->
  <a href="#" class="back-to-top d-flex align-items-center justify-content-center"><i
      class="bi bi-arrow-up-short"></i></a>

  <!-- Vendor JS Files -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="../assets/vendor/apexcharts/apexcharts.min.js"></script>
  <script src="../assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="../assets/vendor/chart.js/chart.umd.js"></script>
  <script src="../assets/vendor/echarts/echarts.min.js"></script>
  <script src="../assets/vendor/quill/quill.min.js"></script>
  <!-- <script src="../assets/vendor/simple-datatables/simple-datatables.js"></script> -->
  <!-- <script src="../assets/vendor/simple-datatables/doctor-datatables.js"></script> -->
  <script src="../assets/vendor/tinymce/tinymce.min.js"></script>
  <script src="../assets/vendor/php-email-form/validate.js"></script>

  <!-- Template Main JS File -->
  <script src="../assets/js/main.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>



  <script>



    let myno = 0;

    fetch(`http://175.106.99.31/auth/user`, {
      method: 'GET'
    })
      .then(response => response.json())
      .then(data => {
        if (data.status == "success") {
            //사용자 이름
      document.querySelector("#username").innerHTML = data.data.name;
      //사용자 이미지
      const preImageContainer = document.querySelector("#pre-userimg");
      let phoUrl = "";
      if (data.data.phoUrl != "undefined") {
        phoUrl =
          "http://uyaxhfqyqnwh16694929.cdn.ntruss.com/member-img/" +
          data.data.phoUrl +
          "?type=f&w=36&h=36&quality=100&anilimit=24";
      } else {
        phoUrl = "../assets/img/default_profile.png";
      }
      const phoType = data.data.phoType;
      const phoName = data.data.phoName;

      // 새로운 이미지 요소 생성 및 추가
      const newImg = document.createElement("img");
      newImg.setAttribute("id", "userimg");
      newImg.setAttribute("src", phoUrl);
      newImg.setAttribute("alt", phoName);
      newImg.setAttribute("style", "width:36px; border-radius:50%");
      preImageContainer.appendChild(newImg);
      return data.data;
        } else {
          location.href = "../auth/doctors-login.html"
        }
        return data.data
      })
      .then((user) => {
        if (user.hosName !== undefined) {
          myno = user.no
        } else {
          console.log(user.hosName)
          location.href = "../auth/doctors-login.html"
        }

      })

    //검색기능
    const tbody = document.querySelector('tbody');
    const searchInput = document.querySelector('#search-input');
    // const hospitalNo = document.querySelector('#hospitalNo').value;

    let dataList = [];

    searchInput.addEventListener('input', function () {
      const searchValue = searchInput.value.trim();
      if (searchValue === '') {
        renderDataList(dataList);
      } else {
        const filteredDataList = dataList.filter(function (data) {
          return data.hosName.includes(searchValue) ||
            data.hosAddr.includes(searchValue) ||
            data.hosSub.includes(searchValue);
        });
        renderDataList(filteredDataList);
      }
    });
    //검색기능 출력(렌더링)
    // <td>${row.hosPwd}</td>  비밀번호 필요없음
    // <td>${row.hosTime}</td> 진료시간 필요없음
    function renderDataList(dataList) {
      let html = '';
      for (var row of dataList) {   
        html += `<tr style="cursor:pointer;" onclick="window.location.href='hospitals-view.html?no=${row.hospitalNo}'">
        <td>${row.hospitalNo}</td>
        <td>${row.hosName}</td>
        <td>${row.hosAddr}</td>
        <td>${row.hosTel}</td>        
        <td>${row.hosSub}</td>
        </tr>\n`;
      }
      tbody.innerHTML = html;
    }

    fetch('http://175.106.99.31/hospital/list')
      .then((response) => {
        return response.json();
      })
      .then((data) => {
        dataList = data.data;
        renderDataList(dataList);
      })
      .catch((err) => {
        Swal.fire({
          icon: 'error',
          title: '서버 요청 오류',
          width: 400,
          height: 320,
          showConfirmButton: false,
          timer: 750
        });
        console.log(err);
      });
    // tel 변수
    const hosTel = document.querySelector('.hos-tel');
    const idValidationMsg = document.getElementById('id-validation-msg');
    let isDuplicate = false;

    // tel 중복 확인
    hosTel.addEventListener('keyup', () => {
      const tel = hosTel.value;
      if (tel.length < 7) {
        idValidationMsg.textContent = '번호를 7자 이상 입력하세요.';
        hosTel.classList.remove('is-valid', 'is-invalid');
        hosTel.classList.add('is-invalid');
        idValidationMsg.style.color = '#dc3545';
        return;
      }


      // 유효한 전화번호인 경우에만 fetch 요청을 보냅니다.
      fetch(`http://175.106.99.31/hospital/check-duplicate/${tel}`)
        .then((response) => response.json())
        .then((result) => {
          if (result.status === 'failure') {
            idValidationMsg.textContent = result.message;
            hosTel.classList.remove('is-valid', 'is-invalid');
            hosTel.classList.add('is-invalid');
            idValidationMsg.style.color = '#dc3545';
            isDuplicate = true;
          } else {
            idValidationMsg.textContent = result.message;
            hosTel.classList.remove('is-valid', 'is-invalid');
            hosTel.classList.add('is-valid');
            idValidationMsg.style.color = '#198754';
            isDuplicate = false;
          }
        })
        .catch((exception) => {
          console.error('전화번호 중복 확인 중 오류 발생:', exception);
          idValidationMsg.textContent = '오류가 발생했습니다. 다시 시도해주세요.';
          hosTel.classList.remove('is-valid', 'is-invalid');
          hosTel.classList.add('is-invalid');
          idValidationMsg.style.color = '#dc3545';
        });
    });

    let fileInput = document.querySelector('#hosPhoto');

    fileInput.addEventListener('change', function(e) {
      let files = e.target.files;
      if (files.length > 3) {
        Swal.fire({
          icon: 'question',
          title: '파일 첨부 개수는 3개 이상이 될 수 없습니다.',
          width: 400,
          height: 320,
          showConfirmButton: false,
          timer: 750
        });
        // 최대 첨부 가능한 파일 개수를 넘어서는 경우, 파일 선택을 초기화합니다.
        fileInput.value = '';
      }
    });
    const message = document.querySelector('#hospital-success-message');


    document.querySelector('#btn-submit').onclick = (e) => {
      const hosNameInput = document.querySelector('#hosName');
      const pwdInput = document.querySelector('#hosPwd');    


       if(hosNameInput.value == ""){
        Swal.fire({
          icon: 'question',
          title: '병원명을 입력해주세요.',
          width: 400,
          height: 320,
          showConfirmButton: false,
          timer: 750
        });
        return false;
      }

      if(pwdInput.value == "" || pwdInput.value.length < 4){
        Swal.fire({
          icon: 'error',
          title: '비밀번호를 4자 이상 입력해주세요.',
          width: 400,
          height: 320,
          showConfirmButton: false,
          timer: 750
        });
        return false;
      }
      if (hosTel.value === '' || hosTel.value.length < 7) {
        Swal.fire({
          icon: 'error',
          title: '전화번호를 7자 이상 입력해주세요.',
          width: 400,
          height: 320,
          showConfirmButton: false,
          timer: 750
        });
        return false;
      }
      document.getElementById("btn-submit").style.display = "none";

      //인풋태그 read only로 변경
      function makeInputsReadonly() {
        var inputs = document.querySelectorAll(".hos-name, .hos-addr, .hos-tel, .hos-time, .hos-sub, .hos-pwd, .hos-photo");
        inputs.forEach(function (input) {
          input.setAttribute("readonly", true);
          input.style.color = 'grey;';
        });
      }
      makeInputsReadonly();

      fetch("http://175.106.99.31/hospital", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          hosName: document.querySelector('#hosName').value,
          hosAddr: document.querySelector('#hosAddr').value,
          hosTel: document.querySelector('#hosTel').value,
          hosTime: document.querySelector('#hosTime').value,
          hosSub: document.querySelector('#hosSub').value,
          hosPwd: document.querySelector('#hosPwd').value,
        }),
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("성공:", data);
          message.style.display = 'block';
          submitFiles(data.data.hospitalNo);
          console.log(data.data.hospitalNo);
        })
        .catch((error) => {
          console.error("실패:", error);
        })

    };

    function submitFiles(no) {
      console.log(no);
      let formData = new FormData();
      let files = document.querySelector(".hospital-files").files;

      if (files.length == 0) {
        return
      }

      for (let i = 0; i < files.length; i++) {
        if (files[i].name.includes(".bmp") ||
          files[i].name.includes(".jpeg") ||
          files[i].name.includes(".jpg") ||
          files[i].name.includes(".gif") ||
          files[i].name.includes(".png") ||
          files[i].name.includes(".tiff") ||
          files[i].name.includes(".psd") ||
          files[i].name.includes(".tga") ||
          files[i].name.includes(".ai") ||
          iles[i].name.includes(".svg") ||
          files[i].name.includes(".exif") ||
          files[i].name.includes(".jfif")) {

          formData.append("files", files[i]);
          formData.append("hosNo", no); //  여기 입력되는 정수가 커뮤 번호여야 한다
        }
      }
      $.ajax({
        url: 'http://175.106.99.31/hospitalImg/insertHosImg',
        data: formData,
        cache: false,
        contentType: false,
        processData: false,
        type: 'POST',
        success: function (data) {
          console.log("데이터 업로드 성공");
        },
        error: function (e) {
          console.log("데이터 업로드 실패");
        }
      });
    }

  </script>
  <script>


  </script>
</body>

</html>